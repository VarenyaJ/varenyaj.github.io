<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tetris Deluxe v6</title>
<style>
 body {
   background: #111;
   color: #fff;
   font-family: Courier, monospace;
   display: flex;
   flex-direction: column;
   align-items: center;
   margin: 0;
   padding: 10px;
 }
 h1 {
   margin: 5px 0 10px 0;
 }
 #game-area {
   display: flex;
   flex-direction: row;
   gap: 20px;
   align-items: flex-start;
   justify-content: center;
   flex-wrap: wrap;
 }
 #gameCanvas {
   border: 2px solid #fff;
   background: #000;
   width: 240px;
   height: 480px;
 }
 #hud {
   background: #222;
   border: 1px solid #555;
   border-radius: 4px;
   padding: 10px;
   min-width: 100px;
   font-size: 14px;
   display: flex;
   flex-direction: column;
   align-items: center;
 }
 #preview, #hold {
   border: 1px solid #555;
   background: #000;
   margin-bottom: 10px;
   width: 80px;
   height: 80px;
 }
 #controls {
   margin-top: 10px;
   font-size: 12px;
   color: #0f0;
   text-align: center;
   line-height: 1.5em;
   max-width: 320px;
 }
</style>
</head>
<body>
<h1>Tetris Deluxe</h1>

<div id="game-area">
 <canvas id="gameCanvas" width="200" height="400"></canvas>

 <div id="hud">
   <canvas id="preview" width="80" height="80"></canvas>
   <canvas id="hold" width="80" height="80"></canvas>
   <div id="score">Score: 0</div>
   <div id="lines">Lines: 0</div>
   <div id="level">Level: 1</div>
   <div id="highscore">High Score: 0</div>

   <!-- New flag status panel -->
   <div id="flags" style="font-size:11px; color:#0f0; margin-top:8px; line-height:1.4em;"></div>
 </div>
</div>

<div id="controls">
 Move: A/D | Rotate: W | Drop: S | Hold: C<br>
 Restart: R | Toggles -- X=Extra Shapes | K=Wall Kick | G=Ghost
</div>

<script>
/* ===== FEATURE TOGGLES ===== */
let ENABLE_HUD = true;
let ENABLE_COMBO = true;
let ENABLE_LEVELS = true;
let ENABLE_HOLD = true;
let ENABLE_EXTRA_SHAPES = false;
let ENABLE_WALL_KICK = true;
let ENABLE_GHOST = false;
/* =========================== */

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const previewCanvas = document.getElementById("preview");
const pctx = previewCanvas.getContext("2d");
const holdCanvas = document.getElementById("hold");
const hctx = holdCanvas.getContext("2d");

const ROWS = 20, COLS = 10, BLOCK = 20;
let board = [];
let score = 0, lines = 0, level = 1, dropInterval = 800;
let paused = false, gameOver = false;
let combo = 0, canHold = true;
let lastTime = 0, dropCounter = 0;
let nextMatrix = null;
let holdMatrix = null;

const COLORS = [null,"#f00","#0f0","#00f","#ff0","#0ff","#f0f","#fa0","#a0f","#08f","#3f3"];
const BASE_SHAPES = {
 I: [[1,1,1,1]],
 J: [[2,0,0],[2,2,2]],
 L: [[0,0,3],[3,3,3]],
 O: [[4,4],[4,4]],
 S: [[0,5,5],[5,5,0]],
 T: [[0,6,0],[6,6,6]],
 Z: [[7,7,0],[0,7,7]]
};
const EXTRA_SHAPES = {
 PLUS: [[0,8,0],[8,8,8],[0,8,0]],
 BIGL: [[9,0,0],[9,0,0],[9,9,9]],
 SMALLS: [[10,10,0],[0,10,10]]
};
function getShapes(){return ENABLE_EXTRA_SHAPES ? {...BASE_SHAPES, ...EXTRA_SHAPES} : BASE_SHAPES;}

function createMatrix(w,h){return Array.from({length:h},()=>Array(w).fill(0));}

function drawMatrix(matrix,offset,context=ctx,blockSize=BLOCK,opacity=1){
 context.globalAlpha=opacity;
 matrix.forEach((row,y)=>row.forEach((val,x)=>{
   if(val){
     context.fillStyle=COLORS[val];
     context.fillRect((x+offset.x)*blockSize,(y+offset.y)*blockSize,blockSize-1,blockSize-1);
   }
 }));
 context.globalAlpha=1;
}

function collide(board,piece){
 const [m,o]=[piece.matrix,piece.pos];
 for(let y=0;y<m.length;y++){
   for(let x=0;x<m[y].length;x++){
     if(m[y][x] && (
       !board[y+o.y] ||
       board[y+o.y][x+o.x]!==0
     )) return true;
   }
 }
 return false;
}

function merge(board,piece){
 piece.matrix.forEach((row,y)=>row.forEach((v,x)=>{
   if(v) board[y+piece.pos.y][x+piece.pos.x]=v;
 }));
}

function rotateMatrix(m){
 const N=m.length,M=m[0].length;
 let r=Array(M).fill().map(()=>Array(N).fill(0));
 for(let y=0;y<N;y++) for(let x=0;x<M;x++) r[x][N-1-y]=m[y][x];
 return r;
}

function playerRotate(dir){
 const old=player.matrix;
 const rotated=dir>0?rotateMatrix(old):rotateMatrix(rotateMatrix(rotateMatrix(old)));
 const pos=player.pos.x;
 player.matrix=rotated;
 if(!ENABLE_WALL_KICK){
   if(collide(board,player)) player.matrix=old;
   return;
 }
 const offsets=[0,1,-1,2,-2];
 for(let o of offsets){
   player.pos.x=pos+o;
   if(!collide(board,player)) return;
 }
 player.matrix=old; player.pos.x=pos;
}

function drawHUD(){
 if(!ENABLE_HUD) return;
 document.getElementById("score").textContent="Score: "+score;
 document.getElementById("lines").textContent="Lines: "+lines;
 document.getElementById("level").textContent="Level: "+level;
 document.getElementById("highscore").textContent="High Score: "+(localStorage.getItem("highscore")||0);
}

function arenaSweep(){
 let cleared=0;
 outer: for(let y=board.length-1;y>=0;y--){
   for(let x=0;x<board[y].length;x++){
     if(board[y][x]===0) continue outer;
   }
   board.splice(y,1);
   board.unshift(Array(COLS).fill(0));
   cleared++; y++;
 }
 if(cleared>0){
   lines+=cleared;
   let gain=100*cleared;
   if(ENABLE_COMBO){combo++;gain+=combo*50;}else combo=0;
   if(ENABLE_LEVELS && lines%10===0 && dropInterval>100){level++;dropInterval-=100;}
   score+=gain*level;
 } else combo=0;
 drawHUD();
}

function playerReset(){
 const shapes=Object.keys(getShapes());
 if(!nextMatrix) nextMatrix=getShapes()[shapes[Math.floor(Math.random()*shapes.length)]].map(r=>r.slice());
 player.matrix=nextMatrix;
 player.pos.y=0;
 player.pos.x=(COLS/2|0)-(player.matrix[0].length/2|0);
 nextMatrix=getShapes()[shapes[Math.floor(Math.random()*shapes.length)]].map(r=>r.slice());
 drawPreview();
 canHold=true;
 if(collide(board,player)){gameOver=true;}
}

function drawPreview(){
 pctx.fillStyle="#000";pctx.fillRect(0,0,80,80);
 const m=nextMatrix;
 drawMatrix(m,{x:(4-m[0].length)/2,y:(4-m.length)/2},pctx,16);
}

function drawHold(){
 hctx.fillStyle="#000";hctx.fillRect(0,0,80,80);
 if(holdMatrix) drawMatrix(holdMatrix,{x:(4-holdMatrix[0].length)/2,y:(4-holdMatrix.length)/2},hctx,16);
}

function holdPiece(){
 if(!ENABLE_HOLD || !canHold) return;
 if(!holdMatrix){
   holdMatrix=player.matrix;
   playerReset();
 } else {
   [player.matrix,holdMatrix]=[holdMatrix,player.matrix];
   player.pos.y=0;
   player.pos.x=(COLS/2|0)-(player.matrix[0].length/2|0);
 }
 canHold=false;
 drawHold();
}

function playerMove(offset){
 player.pos.x+=offset;
 if(collide(board,player)) player.pos.x-=offset;
}

function playerDrop(){
 player.pos.y++;
 if(collide(board,player)){
   player.pos.y--;
   merge(board,player);
   arenaSweep();
   playerReset();
 }
 dropCounter=0;
}

function drawGhost(){
 if(!ENABLE_GHOST) return;
 let ghostY = player.pos.y;
 while(!collide(board,{matrix:player.matrix,pos:{x:player.pos.x,y:ghostY+1}})) ghostY++;
 drawMatrix(player.matrix,{x:player.pos.x,y:ghostY},ctx,BLOCK,0.3);
}

function draw(){
 ctx.fillStyle="#000";
 ctx.fillRect(0,0,canvas.width,canvas.height);
 drawMatrix(board,{x:0,y:0});
 drawGhost();
 drawMatrix(player.matrix,player.pos);
}

/* --- New helper: shows flag statuses --- */
function updateFlagsDisplay() {
 const el = document.getElementById("flags");
 if (!el) return;
 el.innerHTML = `
   <b>Settings</b><br>
   Extra Shapes: ${ENABLE_EXTRA_SHAPES ? "ON" : "OFF"}<br>
   Wall Kick: ${ENABLE_WALL_KICK ? "ON" : "OFF"}<br>
   Ghost Piece: ${ENABLE_GHOST ? "ON" : "OFF"}<br>
   Combo: ${ENABLE_COMBO ? "ON" : "OFF"}<br>
   Levels: ${ENABLE_LEVELS ? "ON" : "OFF"}<br>
   Hold: ${ENABLE_HOLD ? "ON" : "OFF"}
 `;
}

function update(time=0){
 const delta=time-lastTime; lastTime=time;
 if(!paused && !gameOver){
   dropCounter+=delta;
   if(dropCounter>dropInterval) playerDrop();
 }
 draw();
 if(!gameOver) requestAnimationFrame(update);
}

document.addEventListener("keydown",e=>{
 const k=e.key.toLowerCase();
 if((k==="arrowleft"||k==="a")&&!paused) playerMove(-1);
 else if((k==="arrowright"||k==="d")&&!paused) playerMove(1);
 else if((k==="arrowdown"||k==="s")&&!paused) playerDrop();
 else if((k==="arrowup"||k==="w")&&!paused) playerRotate(1);
 else if(k==="c"&&!paused) holdPiece();
 else if(k==="x"){ENABLE_EXTRA_SHAPES=!ENABLE_EXTRA_SHAPES; playerReset(); updateFlagsDisplay();}
 else if(k==="k"){ENABLE_WALL_KICK=!ENABLE_WALL_KICK; updateFlagsDisplay();}
 else if(k==="g"){ENABLE_GHOST=!ENABLE_GHOST; updateFlagsDisplay();}
 else if(k==="r"){board=createMatrix(COLS,ROWS);score=lines=level=0;combo=0;dropInterval=800;paused=false;gameOver=false;playerReset();drawHUD();updateFlagsDisplay();}
});

board=createMatrix(COLS,ROWS);
const player={pos:{x:0,y:0},matrix:null};
playerReset(); drawHUD(); updateFlagsDisplay(); update();
</script>
</body>
</html>